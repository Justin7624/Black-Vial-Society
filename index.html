<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Black Vial Society — Peptide Guide</title>
<style>
  :root{
    --bg:#0e0f12; --card:#16171c; --ink:#e8e9ef; --ink-2:#b8b9c2;
    --brand:#63e6be; --brand-2:#3fc29a; --shadow:0 10px 30px rgba(0,0,0,.35);
    --classic-a:#7c5cff; --classic-b:#5b9dff; --classic-c:#25d0a6;
    --warn:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.45}
  img{max-width:100%;display:block}

  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#0e0f12 60%,rgba(14,15,18,.7));border-bottom:1px solid #222531}
  .wrap{max-width:1100px;margin:auto;padding:18px}
  .brand-banner{display:flex;justify-content:center}
  .banner-img{width:min(660px,90vw);filter:drop-shadow(var(--shadow))}
  .tabs{display:flex;gap:8px;margin-top:10px}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid #2b2e3b;background:#1b1d24;color:#c7c9d6;cursor:pointer}
  .tab.active{background:rgba(99,230,190,.12);border-color:#3fc29a;color:#e8e9ef}
  .section{display:none}
  .section.active{display:block}

  .title-row{display:flex;align-items:center;gap:10px;margin-top:12px}
  .title-row h1{margin:0;font-size:22px;font-weight:800}
  .vial-icon{width:28px;height:auto;filter:drop-shadow(0 6px 18px rgba(0,0,0,.35))}

  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:18px}
  .search{flex:1 1 340px;display:flex;gap:10px;align-items:center;background:#16171c;border:1px solid #272a36;border-radius:999px;padding:10px 14px;box-shadow:var(--shadow)}
  .search input{flex:1;border:0;background:transparent;color:var(--ink);outline:none}
  .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid #2b2e3b;background:#1e2027;color:#b8b9c2;padding:8px 12px;border-radius:999px;cursor:pointer}
  .chip.active{border-color:#3fc29a;background:rgba(99,230,190,.12);color:#e8e9ef}

  .grid{display:grid;gap:16px;margin:16px 0 80px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
  .card{background:linear-gradient(180deg,#16171c,#15161b);border:1px solid #262938;border-radius:14px;padding:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px}
  .title{display:flex;justify-content:space-between;align-items:center}
  .title h3{margin:0;font-size:16px}
  .pill{font-size:11px;background:rgba(99,230,190,.12);color:#63e6be;border:1px solid #3fc29a;padding:5px 8px;border-radius:999px}
  .desc{color:#b8b9c2;font-size:13px}
  .onset{color:#e9e9f5;font-size:12px;background:#1c2130;border:1px dashed #2f3650;padding:8px;border-radius:10px}
  .dose-label{font-size:12px;color:#cfd0d8}
  .doses{display:flex;flex-wrap:wrap;gap:8px}
  .dose{
    padding:6px 10px;border-radius:10px;border:1px solid #2b2e3b;background:#1a1c22;
    font-size:12px;color:var(--ink);cursor:pointer;display:inline-flex;align-items:center;gap:8px;
  }
  .dose:disabled{cursor:not-allowed;opacity:.55}
  .stock-badge{
    font-size:11px; padding:2px 7px; border-radius:999px;
    border:1px solid #2b2e3b; background:#12141a; color:#aab2c5;
  }
  .stock-badge.ok{border-color:#2f7b62;color:#aef2dc;background:rgba(99,230,190,.08)}
  .stock-badge.low{border-color:#7a6a2f;color:#ffe7a6;background:rgba(255,215,106,.08)}
  .stock-badge.out{border-color:#7a2f2f;color:#ffb0b0;background:rgba(255,107,107,.10)}
  .empty{color:#b8b9c2;text-align:center;padding:40px;border:1px dashed #2b2f3d;border-radius:14px;background:#14161a}

  /* Mini calculator dropdown */
  .mini-wrap{margin-top:8px;border:1px solid #2a2d3c;background:#14161b;border-radius:12px;overflow:hidden;display:none}
  .mini-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;font-weight:700;font-size:13px}
  .mini-sub{font-size:12px;color:#b8b9c2;font-weight:600}
  .close-mini{cursor:pointer;border:1px solid #2b2e3b;background:#1a1d26;border-radius:999px;color:#cfd0d8;padding:6px 10px;font-size:12px}
  .mini-body{display:grid;gap:12px;padding:10px 12px;border-top:1px solid #24283a}

  .mini-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .mini-field{display:flex;flex-direction:column;gap:6px}
  .mini-field label{font-size:12px;color:#b8b9c2}
  .mini-field input, .mini-field select{background:#0f1116;border:1px solid #2b2e3b;border-radius:10px;color:#e8e9ef;padding:8px 10px;font-size:13px}

  .dose-row{display:grid;grid-template-columns:96px 72px;gap:8px;align-items:center;justify-content:start;}
  .dose-row .desired-input{width:96px !important;max-width:96px !important;}
  .dose-row select{width:72px !important;min-width:72px !important;max-width:72px !important;padding:6px 8px;font-size:12px;}

  /* Classic syringe visual (mini) */
  .classic{background:#0c0d11;border:1px solid #272930;border-radius:12px;padding:12px;margin-top:6px}
  .tube{position:relative;height:28px;border-radius:16px;background:linear-gradient(180deg,#11131a,#0b0c10);border:1px solid #2a2c33;box-shadow:inset 0 2px 8px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.05)}
  .fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,var(--classic-a),var(--classic-b));border-radius:16px;box-shadow:inset 0 0 12px rgba(255,255,255,.25), 0 0 16px rgba(124,92,255,.45)}
  .cursor{position:absolute;top:-6px;width:2px;background:var(--classic-c);height:40px;border-radius:2px;box-shadow:0 0 0 2px rgba(37,208,166,.15)}
  .ticks{position:relative;display:flex;justify-content:space-between;align-items:flex-start;margin-top:8px;margin-bottom:6px;padding:0 2px}
  .tick{position:relative;width:1px;background:#3a3d47}
  .tick.minor{height:8px;opacity:.55}
  .tick.major{height:14px}
  .tick .n{position:absolute;top:16px;left:50%;transform:translateX(-50%);font-size:11px;color:#aab2c5}

  .mini-stats{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:18px}
  .stat{background:#10131a;border:1px dashed #2c3450;padding:10px;border-radius:10px;font-size:13px}
  .stat b{display:block;font-size:12px;color:#9fb3d2;margin-bottom:4px}
  .warn{margin-top:10px;color:var(--warn);font-weight:700;font-size:13px}

  /* Price table */
  .price-toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:12px 14px;font-size:14px}
  thead th{color:#cfd0d8;text-align:left}
  tbody tr{background:#15161b;border:1px solid #262938;box-shadow:var(--shadow)}
  tbody td:first-child, thead th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
  tbody td:last-child, thead th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
  .num{text-align:right;font-variant-numeric:tabular-nums}
  .unit-pill{font-size:11px;background:#19212c;border:1px solid #2a3446;color:#9fb3d2;padding:3px 8px;border-radius:999px}

  .footer{position:fixed;left:0;right:0;bottom:0;background:#0f1116;border-top:1px solid #242736}
  .foot-wrap{max-width:1100px;margin:auto;padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
  .small{font-size:12px;color:#b8b9c2}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand-banner">
        <img src="Black_Vial_Society_Transparent_Header.png" alt="Black Vial Society" class="banner-img"/>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="guide">Guide</button>
        <button class="tab" data-tab="prices">Price Sheet</button>
      </div>
    </div>
  </header>

  <!-- GUIDE -->
  <main class="wrap section active" id="guide">
    <div class="title-row">
      <img src="Black_Vial_Society_Transparent_Logo.png" class="vial-icon" alt="Vial"/>
      <h1>Peptide Guide</h1>
    </div>

    <div class="toolbar">
      <div class="search"><input id="q" placeholder="Search name or purpose… (e.g., weight loss, tanning, energy, healing)"/></div>
      <div class="chip active" data-filter="all">All</div>
      <div class="chip" data-filter="weight">Weight & glucose</div>
      <div class="chip" data-filter="tanning">Tanning</div>
      <div class="chip" data-filter="healing">Injury & recovery</div>
      <div class="chip" data-filter="energy">Energy / anti-aging</div>
      <div class="chip" data-filter="supplies">Mixing supplies</div>
      <button class="chip" id="expand">Expand all</button>
      <button class="chip" id="collapse">Collapse all</button>
    </div>

    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none">No items match your search/filter.</div>
  </main>

  <!-- PRICE SHEET -->
  <main class="wrap section" id="prices">
    <div class="title-row" style="margin-top:6px">
      <img src="Black_Vial_Society_Transparent_Logo.png" class="vial-icon" alt="Vial"/>
      <h1>Price Sheet</h1>
    </div>

    <div class="price-toolbar">
      <div class="search"><input id="pq" placeholder="Search product or strength…"/></div>
      <span class="small">Click headers to sort</span>
    </div>

    <div class="small" style="margin-bottom:8px">Price per unit = price ÷ amount (mg or IU). (Vials only.)</div>
    <table id="priceTable">
      <thead>
        <tr>
          <th class="sort" data-sort="name">Product</th>
          <th class="sort" data-sort="strength">Strength</th>
          <th class="sort num" data-sort="amount">Amount</th>
          <th class="sort num" data-sort="price">Price</th>
          <th class="sort num" data-sort="ppu">Price / unit</th>
          <th class="sort num" data-sort="stock">Stock</th>
          <th>Unit</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="pempty" class="empty" style="display:none">No matches.</div>
  </main>

  <footer class="footer">
    <div class="foot-wrap">
      <div class="small">Educational use only. Not medical advice.</div>
      <div></div>
    </div>
  </footer>

<script>
/* ---------- Utilities ---------- */
const esc = s => String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const money = n => `$${n.toFixed(2)}`;
const num = n => n.toFixed(2);

/* ---------- Classic math with unit handling ---------- */
function classicCalc({mgPerVial, diluentMl, desired, desiredUnit='mg', syringeScale=100}) {
  const mgV = Number(mgPerVial)||0;
  const mlD = Number(diluentMl)||0;
  const want = Number(desired)||0;
  const scale = Number(syringeScale)||100;

  const desiredMg = desiredUnit==='mcg' ? (want/1000) : want;
  const mgPerMl   = (mgV>0 && mlD>0) ? (mgV/mlD) : NaN;
  const mgPerUnit = isFinite(mgPerMl) ? (mgPerMl*0.01) : NaN;
  const units     = (isFinite(mgPerUnit) && desiredMg>=0) ? (desiredMg/mgPerUnit) : NaN;

  const pct = (isFinite(units) && scale>0) ? Math.max(0, Math.min(100, (units/scale)*100)) : 0;
  return { mgPerUnit, units, unitsPct:pct, syringeScale:scale };
}

/* ---------- FULL GUIDE DATA (FROM EXCEL; ALL PRODUCTS INCLUDED) ---------- */
const GUIDE = [
  {key:"5amino1mq", name:"5-amino-1mq", badge:"Metabolic", category:"energy",
    short:"Metabolic support—used for recomposition goals and “leaner” progress.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg","10 mg","50 mg"],
    stock:{"5 mg":10,"10 mg":10,"50 mg":9},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"acetica", name:"Acetic Acid (diluent)", badge:"Supply", category:"supplies",
    short:"Acidic diluent used only when a peptide specifically calls for it.",
    onset:"—",
    fact:"Form: Liquid",
    doses:["10 mL"],
    stock:{"10 mL":8},
    more:"<ul><li>Supply item. Keep sterile and store appropriately.</li></ul>"},
  {key:"ahkcu", name:"AHK-CU", badge:"Skin", category:"energy",
    short:"Copper peptide—supports healthier-looking skin and smoother texture.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["100 mg"],
    stock:{"100 mg":29},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"aod9604", name:"AOD-9604", badge:"Metabolic", category:"energy",
    short:"Fat-loss support peptide—often used for stubborn areas and cutting phases.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg","10 mg"],
    stock:{"5 mg":10,"10 mg":10},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"ara290", name:"ARA-290", badge:"Recovery", category:"healing",
    short:"Research peptide discussed for tissue protection and nerve-related recovery support.",
    onset:"Some notice comfort changes in days; deeper recovery is gradual over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["10 mg"],
    stock:{"10 mg":0},
    more:"<ul><li>Pair recovery support with rest + rehab work for best results.</li></ul>"},
  {key:"bacteriostaticwatergeneric", name:"Bacteriostatic Water (generic)", badge:"Supply", category:"supplies",
    short:"Sterile mixing water for reconstitution. Not a treatment.",
    onset:"—",
    fact:"Form: Liquid",
    doses:["10 mL"],
    stock:{"10 mL":198},
    more:"<ul><li>Supply item. Keep sterile and store appropriately.</li></ul>"},
  {key:"bpc157", name:"BPC-157", badge:"Recovery", category:"healing",
    short:"Often used for injury recovery—tendons, joints, and “nagging” aches.",
    onset:"Some notice comfort changes in days; deeper recovery is gradual over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["10 mg","20 mg"],
    stock:{"10 mg":16,"20 mg":11},
    more:"<ul><li>Pair recovery support with rest + rehab work for best results.</li></ul>"},
  {key:"bpc5mgtb5mgcombo", name:"BPC 5mg + TB 5mg (Combo)", badge:"Recovery", category:"healing",
    short:"Educational summary coming soon.",
    onset:"Some notice comfort changes in days; deeper recovery is gradual over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["10 mg"],
    stock:{"10 mg":13},
    more:"<ul><li>Pair recovery support with rest + rehab work for best results.</li></ul>"},
  {key:"bpc10mgtb10mgcombo", name:"BPC 10mg + TB 10mg (Combo)", badge:"Recovery", category:"healing",
    short:"Educational summary coming soon.",
    onset:"Some notice comfort changes in days; deeper recovery is gradual over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["20 mg"],
    stock:{"20 mg":1},
    more:"<ul><li>Pair recovery support with rest + rehab work for best results.</li></ul>"},
  {key:"cagrilintide", name:"Cagrilintide", badge:"Weight", category:"weight",
    short:"Amylin-pathway support—often described as “quieting food noise.”",
    onset:"Some notice appetite changes within 1–3 weeks; results build over time.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg","10 mg"],
    stock:{"5 mg":14,"10 mg":10},
    more:"<ul><li>Often used alongside diet consistency and activity for best results.</li></ul>"},
  {key:"cjc1295nodac", name:"CJC-1295 (no DAC)", badge:"Body Comp", category:"energy",
    short:"GH-support peptide—often used in body composition and recovery-focused protocols.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg","10 mg"],
    stock:{"5 mg":10,"10 mg":16},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"cjc1295nodacipamorelincombo", name:"CJC-1295 (no DAC) + Ipamorelin (Combo)", badge:"Body Comp", category:"energy",
    short:"Educational summary coming soon.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["10 mg"],
    stock:{"10 mg":0},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"cjc1295withdac", name:"CJC-1295 (with DAC)", badge:"Body Comp", category:"energy",
    short:"Longer-acting GH-support peptide—commonly discussed for steady GH/IGF support.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["2 mg"],
    stock:{"2 mg":10},
    more:"<ul><li>Higher-risk / research-heavy category—do careful research and consider professional guidance.</li></ul>"},
  {key:"dsip", name:"DSIP", badge:"Longevity", category:"energy",
    short:"Sleep support—used for deeper rest and calmer nights.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg","10 mg","15 mg"],
    stock:{"5 mg":10,"10 mg":10,"15 mg":16},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"easytouchinsulinsyringe10pack", name:"EasyTouch insulin syringe (10 pack)", badge:"Supply", category:"supplies",
    short:"Insulin syringes for reconstitution/injection workflows (supply item).",
    onset:"—",
    fact:"Form: Insulin Syringe",
    doses:["10 pack"],
    stock:{"10 pack":70},
    more:"<ul><li>Supply item. Keep sterile and store appropriately.</li></ul>"},
  {key:"epithalon", name:"Epithalon", badge:"Longevity", category:"energy",
    short:"Longevity-style peptide—often used for “aging support” and overall vitality.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["10 mg","50 mg"],
    stock:{"10 mg":10,"50 mg":16},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"foxo4dri", name:"FOXO4-DRI", badge:"Longevity", category:"energy",
    short:"Experimental longevity peptide—often discussed in senescent-cell conversations.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["10 mg"],
    stock:{"10 mg":8},
    more:"<ul><li>Higher-risk / research-heavy category—do careful research and consider professional guidance.</li></ul>"},
  {key:"ghkcu", name:"GHK-CU", badge:"Skin", category:"energy",
    short:"Supports collagen and skin texture; often used in cosmetic-focused routines.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["50 mg","100 mg"],
    stock:{"50 mg":10,"100 mg":5},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"glow", name:"GLOW", badge:"Metabolic", category:"energy",
    short:"Beauty-style blend—marketed for skin glow, tone, and overall wellness vibes.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["70 mg"],
    stock:{"70 mg":27},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"glp1sgsemaglutide", name:"GLP-1SG (Semaglutide)", badge:"Weight", category:"weight",
    short:"Popular for appetite control—can make smaller meals feel satisfying.",
    onset:"Some notice appetite changes within 1–3 weeks; results build over time.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg","10 mg","15 mg","20 mg"],
    stock:{"5 mg":17,"10 mg":16,"15 mg":17,"20 mg":6},
    more:"<ul><li>Often used alongside diet consistency and activity for best results.</li></ul>"},
  {key:"glp2tztirzepatide", name:"GLP-2TZ (Tirzepatide)", badge:"Weight", category:"weight",
    short:"Helps reduce appetite and can support steadier blood sugar.",
    onset:"Some notice appetite changes within 1–3 weeks; results build over time.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg","10 mg","15 mg","20 mg","30 mg","40 mg","50 mg","60 mg"],
    stock:{"5 mg":10,"10 mg":19,"15 mg":20,"20 mg":20,"30 mg":10,"40 mg":10,"50 mg":10,"60 mg":10},
    more:"<ul><li>Often used alongside diet consistency and activity for best results.</li></ul>"},
  {key:"glp3rtretatrutide", name:"GLP-3RT (Retatrutide)", badge:"Weight", category:"weight",
    short:"Strong appetite support; many use it to help cut cravings and stay full longer.",
    onset:"Some notice appetite changes within 1–3 weeks; results build over time.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg","10 mg","15 mg","20 mg","30 mg","40 mg","50 mg","60 mg"],
    stock:{"5 mg":35,"10 mg":118,"15 mg":9,"20 mg":110,"30 mg":10,"40 mg":10,"50 mg":10,"60 mg":10},
    more:"<ul><li>Often used alongside diet consistency and activity for best results.</li></ul>"},
  {key:"glutathione", name:"Glutathione", badge:"Antioxidant", category:"energy",
    short:"Antioxidant support—often used for overall wellness and “bright” skin routines.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["1500 mg"],
    stock:{"1500 mg":11},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"hcg", name:"HCG", badge:"Hormone", category:"energy",
    short:"Hormone (hCG) used in fertility/testicular signaling contexts—best handled with medical guidance.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["5000 iu","10000 iu"],
    stock:{"5000 iu":10,"10000 iu":10},
    more:"<ul><li>Higher-risk / research-heavy category—do careful research and consider professional guidance.</li></ul>"},
  {key:"hgh191aasomatropin", name:"HGH 191AA (Somatropin)", badge:"Hormone", category:"energy",
    short:"Prescription hormone—used for GH therapy under medical supervision.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["10 iu","15 iu","24 iu","36 iu"],
    stock:{"10 iu":49,"15 iu":30,"24 iu":30,"36 iu":17},
    more:"<ul><li>Higher-risk / research-heavy category—do careful research and consider professional guidance.</li></ul>"},
  {key:"hospirabacteriostaticwaterbrand", name:"Hospira Bacteriostatic Water (brand)", badge:"Supply", category:"supplies",
    short:"Brand bacteriostatic water. Useful if you mix often.",
    onset:"—",
    fact:"Form: Liquid",
    doses:["30 mL"],
    stock:{"30 mL":396},
    more:"<ul><li>Supply item. Keep sterile and store appropriately.</li></ul>"},
  {key:"igf1lr3", name:"IGF-1 LR3", badge:"Performance", category:"energy",
    short:"Performance/growth support—often discussed for muscle and recovery goals.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["1 mg"],
    stock:{"1 mg":1},
    more:"<ul><li>Higher-risk / research-heavy category—do careful research and consider professional guidance.</li></ul>"},
  {key:"ipamorelin", name:"Ipamorelin", badge:"Body Comp", category:"energy",
    short:"GH-support peptide—used for recovery, sleep quality, and body composition goals.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg","10 mg"],
    stock:{"5 mg":4,"10 mg":6},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"klow", name:"KLOW", badge:"Metabolic", category:"energy",
    short:"Wellness blend—often described as “feel-good” support and body balance.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["80 mg"],
    stock:{"80 mg":7},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"kpv", name:"KPV", badge:"Longevity", category:"energy",
    short:"Calming support—often used for inflammation-prone skin or sensitive gut vibes.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg","10 mg"],
    stock:{"5 mg":3,"10 mg":0},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"kisspeptin10", name:"KissPeptin-10", badge:"Hormone", category:"energy",
    short:"Hormone signaling peptide—often discussed for reproductive axis support.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["10 mg"],
    stock:{"10 mg":17},
    more:"<ul><li>Higher-risk / research-heavy category—do careful research and consider professional guidance.</li></ul>"},
  {key:"lemonbottle", name:"Lemon Bottle", badge:"Supply", category:"supplies",
    short:"Cosmetic liquid product used in aesthetic contexts; follow label guidance.",
    onset:"—",
    fact:"Form: Liquid",
    doses:["10 mg / 10 mL"],
    stock:{"10 mg / 10 mL":6},
    more:"<ul><li>Supply item. Keep sterile and store appropriately.</li></ul>"},
  {key:"melanotan", name:"Melanotan", badge:"Tanning", category:"tanning",
    short:"Supports tanning response—can help deepen tone with less sun exposure.",
    onset:"Often noticeable over days to weeks.",
    fact:"Form: Lyophilized powder",
    doses:["10 mg"],
    stock:{"10 mg":9},
    more:"<ul><li>Use sun responsibly—this isn’t a free pass for UV damage.</li></ul>"},
  {key:"melanotan2", name:"Melanotan 2", badge:"Tanning", category:"tanning",
    short:"Similar tanning support—many describe faster/deeper results than MT-1.",
    onset:"Often noticeable over days to weeks.",
    fact:"Form: Lyophilized powder",
    doses:["10 mg"],
    stock:{"10 mg":9},
    more:"<ul><li>Use sun responsibly—this isn’t a free pass for UV damage.</li></ul>"},
  {key:"motsc", name:"MOTS-C", badge:"Metabolic", category:"energy",
    short:"Metabolism/energy support—some describe better stamina and “cleaner” energy.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["10 mg","30 mg","40 mg"],
    stock:{"10 mg":9,"30 mg":8,"40 mg":8},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"nad", name:"NAD+", badge:"Energy", category:"energy",
    short:"Energy + clarity support—people use it for a “reset” feeling and better drive.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["500 mg","1000 mg"],
    stock:{"500 mg":13,"1000 mg":17},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"pt141bremelanotide", name:"PT-141 (Bremelanotide)", badge:"Wellness", category:"energy",
    short:"Often discussed for libido/sexual wellness support via melanocortin pathways (non-hormonal).",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["10 mg"],
    stock:{"10 mg":4},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"selank", name:"Selank", badge:"Nootropic", category:"energy",
    short:"Calm focus—often used for stress support without feeling “dull.”",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg","10 mg","20 mg","30 mg"],
    stock:{"5 mg":10,"10 mg":10,"20 mg":0,"30 mg":33},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"semax", name:"Semax", badge:"Nootropic", category:"energy",
    short:"Focus support—often used for clarity, motivation, and “sharp” workdays.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg","10 mg","20 mg","30 mg"],
    stock:{"5 mg":12,"10 mg":10,"20 mg":0,"30 mg":10},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"sermorelinacetate", name:"Sermorelin Acetate", badge:"Body Comp", category:"energy",
    short:"GH-pathway support—often used to improve recovery and overall “rested” feeling.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg","10 mg"],
    stock:{"5 mg":0,"10 mg":8},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"snap8", name:"SNAP-8", badge:"Wellness", category:"energy",
    short:"Cosmetic peptide often used in topical/beauty contexts for “expression line” smoothing.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["10 mg"],
    stock:{"10 mg":0},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"ss31elamipretide", name:"SS-31 (Elamipretide)", badge:"Metabolic", category:"energy",
    short:"Mito support—marketed for steadier energy and better “cell power.”",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["10 mg"],
    stock:{"10 mg":9},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"tb500thymosinb4acetate", name:"TB500 (Thymosin B4 Acetate)", badge:"Recovery", category:"healing",
    short:"Commonly used to support mobility, recovery, and soft tissue repair.",
    onset:"Some notice comfort changes in days; deeper recovery is gradual over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg","10 mg"],
    stock:{"5 mg":6,"10 mg":9},
    more:"<ul><li>Pair recovery support with rest + rehab work for best results.</li></ul>"},
  {key:"tesamorelin", name:"Tesamorelin", badge:"Body Comp", category:"energy",
    short:"Often used for body composition—especially “stubborn” midsection goals.",
    onset:"Usually subtle at first; many describe changes building over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg","10 mg"],
    stock:{"5 mg":0,"10 mg":10},
    more:"<ul><li>Educational info only—always confirm label details for your specific vial.</li></ul>"},
  {key:"vip", name:"VIP", badge:"Recovery", category:"healing",
    short:"Neuropeptide discussed for recovery, gut/immune signaling, and “system calming” support.",
    onset:"Some notice comfort changes in days; deeper recovery is gradual over weeks.",
    fact:"Form: Lyophilized powder",
    doses:["5 mg"],
    stock:{"5 mg":10},
    more:"<ul><li>Pair recovery support with rest + rehab work for best results.</li></ul>"}
];

/* ---------- PRICES (NOW INCLUDES STOCK: [name, strength, price, unit, stock]) ---------- */
const PRICES_RAW = [
  ["GLP-3RT (Retatrutide)","5 mg",15.00,"mg",35],
  ["GLP-3RT (Retatrutide)","10 mg",20.00,"mg",118],
  ["GLP-3RT (Retatrutide)","15 mg",24.00,"mg",9],
  ["GLP-3RT (Retatrutide)","20 mg",28.00,"mg",110],
  ["GLP-3RT (Retatrutide)","30 mg",35.00,"mg",10],
  ["GLP-3RT (Retatrutide)","40 mg",40.00,"mg",10],
  ["GLP-3RT (Retatrutide)","50 mg",45.00,"mg",10],
  ["GLP-3RT (Retatrutide)","60 mg",50.00,"mg",10],

  ["GLP-2TZ (Tirzepatide)","5 mg",16.00,"mg",10],
  ["GLP-2TZ (Tirzepatide)","10 mg",19.00,"mg",19],
  ["GLP-2TZ (Tirzepatide)","15 mg",22.00,"mg",20],
  ["GLP-2TZ (Tirzepatide)","20 mg",24.00,"mg",20],
  ["GLP-2TZ (Tirzepatide)","30 mg",31.00,"mg",10],
  ["GLP-2TZ (Tirzepatide)","40 mg",41.00,"mg",10],
  ["GLP-2TZ (Tirzepatide)","50 mg",44.00,"mg",10],
  ["GLP-2TZ (Tirzepatide)","60 mg",49.00,"mg",10],

  ["GLP-1SG (Semaglutide)","5 mg",20.00,"mg",17],
  ["GLP-1SG (Semaglutide)","10 mg",24.00,"mg",16],
  ["GLP-1SG (Semaglutide)","15 mg",28.00,"mg",17],
  ["GLP-1SG (Semaglutide)","20 mg",35.00,"mg",6],

  ["Cagrilintide","5 mg",20.00,"mg",14],
  ["Cagrilintide","10 mg",30.00,"mg",10],

  ["MOTS-C","10 mg",40.00,"mg",9],
  ["MOTS-C","30 mg",50.00,"mg",8],
  ["MOTS-C","40 mg",55.00,"mg",8],

  ["BPC-157","10 mg",22.00,"mg",16],
  ["BPC-157","20 mg",30.00,"mg",11],

  ["BPC 5mg + TB 5mg (Combo)","10 mg",24.00,"mg",13],
  ["BPC 10mg + TB 10mg (Combo)","20 mg",44.00,"mg",1],

  ["TB500 (Thymosin B4 Acetate)","5 mg",24.00,"mg",6],
  ["TB500 (Thymosin B4 Acetate)","10 mg",22.00,"mg",9],

  ["Melanotan","10 mg",24.00,"mg",9],
  ["Melanotan 2","10 mg",16.00,"mg",9],

  ["GLOW","70 mg",35.00,"mg",27],
  ["KLOW","80 mg",30.00,"mg",7],

  ["NAD+","500 mg",18.00,"mg",13],
  ["NAD+","1000 mg",32.00,"mg",17],

  ["Ipamorelin","5 mg",20.00,"mg",4],
  ["Ipamorelin","10 mg",22.00,"mg",6],

  ["Tesamorelin","5 mg",45.00,"mg",0],
  ["Tesamorelin","10 mg",30.00,"mg",10],

  ["Sermorelin Acetate","5 mg",18.00,"mg",0],
  ["Sermorelin Acetate","10 mg",24.00,"mg",8],

  ["SS-31 (Elamipretide)","10 mg",44.00,"mg",9],

  ["IGF-1 LR3","1 mg",44.00,"mg",1],

  ["GHK-CU","50 mg",19.00,"mg",10],
  ["GHK-CU","100 mg",32.00,"mg",5],

  ["DSIP","5 mg",15.00,"mg",10],
  ["DSIP","10 mg",18.00,"mg",10],
  ["DSIP","15 mg",21.00,"mg",16],

  ["Epithalon","10 mg",15.00,"mg",10],
  ["Epithalon","50 mg",36.00,"mg",16],

  ["KPV","5 mg",15.00,"mg",3],
  ["KPV","10 mg",20.00,"mg",0],

  ["Semax","5 mg",13.00,"mg",12],
  ["Semax","10 mg",17.00,"mg",10],
  ["Semax","20 mg",32.00,"mg",0],
  ["Semax","30 mg",30.00,"mg",10],

  ["Selank","5 mg",13.00,"mg",10],
  ["Selank","10 mg",17.00,"mg",10],
  ["Selank","20 mg",32.00,"mg",0],
  ["Selank","30 mg",30.00,"mg",33],

  ["5-amino-1mq","5 mg",45.00,"mg",10],
  ["5-amino-1mq","10 mg",30.00,"mg",10],
  ["5-amino-1mq","50 mg",34.00,"mg",9],

  ["CJC-1295 (no DAC)","5 mg",15.00,"mg",10],
  ["CJC-1295 (no DAC)","10 mg",20.00,"mg",16],
  ["CJC-1295 (no DAC) + Ipamorelin (Combo)","10 mg",24.00,"mg",0],

  ["CJC-1295 (with DAC)","2 mg",21.00,"mg",10],

  ["AOD-9604","5 mg",18.00,"mg",10],
  ["AOD-9604","10 mg",27.00,"mg",10],

  ["FOXO4-DRI","10 mg",50.00,"mg",8],

  ["AHK-CU","100 mg",45.00,"mg",29],

  ["Glutathione","1500 mg",20.00,"mg",11],

  ["HGH 191AA (Somatropin)","10 iu",18.00,"iu",49],
  ["HGH 191AA (Somatropin)","15 iu",22.00,"iu",30],
  ["HGH 191AA (Somatropin)","24 iu",26.00,"iu",30],
  ["HGH 191AA (Somatropin)","36 iu",30.00,"iu",17],

  ["KissPeptin-10","10 mg",22.00,"mg",17],

  ["PT-141 (Bremelanotide)","10 mg",20.00,"mg",4],
  ["VIP","5 mg",20.00,"mg",10],
  ["HCG","5000 iu",20.00,"iu",10],
  ["HCG","10000 iu",30.00,"iu",10],
  ["SNAP-8","10 mg",20.00,"mg",0],
  ["ARA-290","10 mg",20.00,"mg",0],

  /* supplies (DO NOT increase) */
  ["Bacteriostatic Water (generic)","10 mL",5.00,"mL",198],
  ["Hospira Bacteriostatic Water (brand)","30 mL",15.00,"mL",396],
  ["Acetic Acid (diluent)","10 mL",6.00,"mL",8],
  ["EasyTouch insulin syringe (10 pack)","10 pack",5.00,"pack",70],
  ["Lemon Bottle","10 mg / 10 mL",20.00,"mL",6]
];

const NO_INCREASE = new Set([
  "bacteriostatic water (generic)",
  "hospira bacteriostatic water (brand)",
  "acetic acid (diluent)",
  "bacteriostatic water",
  "hospira bacteriostatic water",
  "acetic acid",
  "easytouch insulin syringe (10 pack)",
  "lemon bottle"
]);

/* ---------- Helper: Round UP to nearest 5 or 10 ---------- */
function roundSmart(n){
  const step = n <= 100 ? 5 : 10;
  const lower = Math.floor(n / step) * step;
  const upper = Math.ceil(n / step) * step;
  if (n - lower <= 1.5) return lower;
  return upper;
}

const PRICE_MULTIPLIER = 4.29;

/* Selling prices derived from base cost unless supplies/pack/mL */
const PRICES = PRICES_RAW.map(([name, strength, price, unit, stock]) => {
  const skip = NO_INCREASE.has(String(name).toLowerCase()) || unit === 'mL' || unit === 'pack';
  const rawPrice = skip ? Number(price) : Number(price) * PRICE_MULTIPLIER;
  const finalPrice = roundSmart(rawPrice);
  return [name, strength, finalPrice, unit, Number(stock)||0];
});

/* ---------- Starter dose map (neutral defaults) ---------- */
const STARTERS = Object.fromEntries(GUIDE.map(x => [x.key, {dose:0, unit:'mg'}]));

/* ---------- GUIDE + MINI CLASSIC ---------- */
const grid  = document.getElementById('grid');
const empty = document.getElementById('empty');
const q     = document.getElementById('q');

function stockBadgeHTML(stock){
  const s = Number(stock)||0;
  const cls = s<=0 ? 'out' : (s<=5 ? 'low' : 'ok');
  const label = s<=0 ? 'Out' : `${s} in stock`;
  return `<span class="stock-badge ${cls}">${label}</span>`;
}

function classicMiniHTML(id, mgPerVial, starter, syringeScale=100, stock=0, label="") {
  const diluentDefault = 1.0;
  const res = classicCalc({
    mgPerVial, diluentMl:diluentDefault,
    desired: starter.dose, desiredUnit: starter.unit, syringeScale
  });
  const mcgPerUnit = res.mgPerUnit*1000;

  return `
    <div class="mini-head">
      <div>
        Peptide calculator
        <div class="mini-sub">${esc(label)} • ${stockBadgeHTML(stock)}</div>
      </div>
      <button class="close-mini" data-close="${id}">Close</button>
    </div>
    <div class="mini-body" data-mini="${id}">
      <div class="mini-grid">
        <div class="mini-field">
          <label>Peptide per vial (mg)</label>
          <input type="number" step="0.01" value="${isFinite(mgPerVial)?mgPerVial:0}" data-role="mgPerVial">
        </div>
        <div class="mini-field">
          <label>Diluent added (mL)</label>
          <input type="number" step="0.01" value="${diluentDefault}" data-role="diluentMl">
        </div>

        <div class="mini-field">
          <label>Desired dose</label>
          <div class="dose-row">
            <input class="desired-input" type="number" step="0.001" value="${starter.dose}" data-role="desired">
            <select data-role="unit">
              <option value="mg"${starter.unit==='mg'?' selected':''}>mg</option>
              <option value="mcg"${starter.unit==='mcg'?' selected':''}>mcg</option>
            </select>
          </div>
        </div>

        <div class="mini-field">
          <label>Syringe scale</label>
          <select data-role="syringe">
            <option value="30">U-30</option>
            <option value="50">U-50</option>
            <option value="100" selected>U-100</option>
          </select>
        </div>
      </div>

      <div class="classic" data-classic>
        <div class="tube"><div class="fill" data-fill style="width:${res.unitsPct}%"></div><div class="cursor" data-cursor style="left:calc(${res.unitsPct}% - 1px)"></div></div>
        <div class="ticks" data-ticks></div>
        <div class="mini-stats">
          <div class="stat"><b>Units to pull</b><span data-out="units">${(isFinite(res.units)?res.units:0).toFixed(2)}</span></div>
          <div class="stat"><b>Potency</b>
            <span><span data-out="mgPerUnit">${(isFinite(res.mgPerUnit)?res.mgPerUnit:0).toFixed(4)}</span> mg per unit
              (<span data-out="mcgPerUnit">${(isFinite(mcgPerUnit)?mcgPerUnit:0).toFixed(2)}</span> mcg/unit)
            </span>
          </div>
        </div>
        <div class="warn" data-warn style="display:none"></div>
        <div class="small" style="opacity:.85;margin-top:6px">Assumes insulin syringe; scale (30/50/100 units) chosen above. 1 unit = 0.01 mL.</div>
      </div>
    </div>
  `;
}

function doseChipHTML(cardId, doseStr, stock){
  const id = `${cardId}-${doseStr.replace(/\s+/g,'')}`;
  const disabled = (Number(stock)||0) <= 0;
  return `
    <button class="dose" ${disabled?'disabled':''} data-stock="${Number(stock)||0}" data-dose="${doseStr}" data-for="${cardId}" aria-controls="mini-${id}" aria-expanded="false">
      <span>${doseStr}</span>
      ${stockBadgeHTML(stock)}
    </button>
    <div id="mini-${id}" class="mini-wrap"></div>
  `;
}

function cardHTML(item, idx){
  const cardId = `card${idx}-${item.key}`;
  const showOnset = item.category!=='supplies' && item.onset && item.onset.trim()!=='—';
  return `
    <article class="card" id="${cardId}" data-cat="${item.category}" data-key="${item.key}">
      <div class="title"><h3>${esc(item.name)}</h3><span class="pill">${esc(item.badge)}</span></div>
      <p class="desc">${esc(item.short)}</p>
      ${showOnset?`<div class="onset"><strong>When you notice changes:</strong> ${esc(item.onset)}</div>`:''}
      ${item.fact?`<div class="small" style="opacity:.9">Fact: ${esc(item.fact)}</div>`:''}
      <div class="dose-label">Available sizes:</div>
      <div class="doses">${item.doses.map(d=>doseChipHTML(cardId,d,(item.stock && item.stock[d])||0)).join('')}</div>
      <details class="dropdown"><summary>More info <span class="small" style="opacity:.7">▼</span></summary><div class="drop-body">${item.more}</div></details>
    </article>
  `;
}

function buildTicks(elTicks, scaleMax){
  elTicks.innerHTML='';
  const minorStep = (scaleMax<=30?1:(scaleMax===50?1:2));
  const majorStep = (scaleMax<=30?5:(scaleMax===50?5:10));
  for(let i=0;i<=scaleMax;i+=minorStep){
    const div=document.createElement('div');
    div.className = 'tick ' + (i%majorStep===0?'major':'minor');
    elTicks.appendChild(div);
    if(i%majorStep===0){
      const n=document.createElement('div'); n.className='n'; n.textContent=String(i);
      div.appendChild(n);
    }
  }
}

function wireMini(container){
  const scope   = container.querySelector('[data-mini]');
  const classic = container.querySelector('[data-classic]');
  const elTicks = classic.querySelector('[data-ticks]');
  const fillEl  = classic.querySelector('[data-fill]');
  const curEl   = classic.querySelector('[data-cursor]');
  const warnEl  = classic.querySelector('[data-warn]');
  const syringeSel = scope.querySelector('[data-role="syringe"]');

  const read = () => ({
    mgPerVial: Number(scope.querySelector('[data-role="mgPerVial"]').value),
    diluentMl: Number(scope.querySelector('[data-role="diluentMl"]').value),
    desired:   Number(scope.querySelector('[data-role="desired"]').value),
    unit:      scope.querySelector('[data-role="unit"]').value,
    scale:     Number(syringeSel.value)
  });

  const write = (res) => {
    const uOut = classic.querySelector('[data-out="units"]');
    const mgU  = classic.querySelector('[data-out="mgPerUnit"]');
    const mcgU = classic.querySelector('[data-out="mcgPerUnit"]');

    uOut.textContent = isFinite(res.units)?res.units.toFixed(2):'—';
    mgU.textContent  = isFinite(res.mgPerUnit)?res.mgPerUnit.toFixed(4):'—';
    mcgU.textContent = isFinite(res.mgPerUnit)?(res.mgPerUnit*1000).toFixed(2):'—';

    const pct = (isFinite(res.units)&&res.syringeScale>0) ? Math.max(0,Math.min(100,(res.units/res.syringeScale)*100)) : 0;
    fillEl.style.width = pct + '%';
    curEl.style.left   = `calc(${pct}% - 1px)`;

    if (isFinite(res.units) && res.units > res.syringeScale) {
      warnEl.textContent = `⚠️ Dose exceeds the selected syringe scale of ${res.syringeScale} units. Consider more diluent, a larger syringe, or a smaller dose.`;
      warnEl.style.display = 'block';
    } else {
      warnEl.textContent = '';
      warnEl.style.display = 'none';
    }
  };

  function recalcAndRender(){
    const v = read();
    buildTicks(elTicks, v.scale||100);
    const res = classicCalc({
      mgPerVial: v.mgPerVial, diluentMl: v.diluentMl,
      desired: v.desired, desiredUnit: v.unit, syringeScale: v.scale||100
    });
    write(res);
  }

  ['input','change','keyup'].forEach(evt=>{
    scope.querySelectorAll('input,select').forEach(el=>el.addEventListener(evt,recalcAndRender));
  });

  recalcAndRender();
}

function renderGuide(list){
  grid.innerHTML = list.map((x,i)=>cardHTML(x,i)).join('');
  empty.style.display = list.length ? 'none' : 'block';

  grid.querySelectorAll('.dose').forEach(btn=>{
    btn.addEventListener('click',()=>{
      if (btn.disabled) return;

      const doseStr = btn.dataset.dose;
      const stock   = Number(btn.dataset.stock)||0;
      const card    = btn.closest('.card');
      const key     = card.dataset.key;
      const starter = STARTERS[key] || {dose:0, unit:'mg'};
      const mgFromChip = /([\d.]+)\s*mg/i.test(doseStr) ? parseFloat(doseStr) : NaN;

      const cardId = btn.dataset.for;
      const miniId = `mini-${cardId}-${doseStr.replace(/\s+/g,'')}`;
      const mini   = document.getElementById(miniId);
      const open   = mini.style.display==='block';

      document.querySelectorAll('.mini-wrap').forEach(m=>m.style.display='none');
      document.querySelectorAll('.dose').forEach(d=>d.setAttribute('aria-expanded','false'));

      if(!open){
        const vialMg = isNaN(mgFromChip) ? 0 : mgFromChip;
        mini.innerHTML = classicMiniHTML(miniId, vialMg, starter, 100, stock, doseStr);
        mini.style.display = 'block';
        btn.setAttribute('aria-expanded','true');
        wireMini(mini);
        mini.querySelector('.close-mini').addEventListener('click', ()=>{
          mini.style.display='none';
          btn.setAttribute('aria-expanded','false');
        });
      }
    });
  });
}

/* Filters & render */
let activeFilter='all';
function applyFilters(){
  const term=(q.value||'').toLowerCase();
  const filtered = GUIDE.filter(x=>{
    const pass = activeFilter==='all'||x.category===activeFilter;
    const blob = (x.name+' '+x.short+' '+x.badge+' '+x.category+' '+(x.fact||'')).toLowerCase();
    return pass && (term===''||blob.includes(term));
  });
  renderGuide(filtered);
}
renderGuide(GUIDE);
document.getElementById('expand').addEventListener('click',()=>document.querySelectorAll('details').forEach(d=>d.open=true));
document.getElementById('collapse').addEventListener('click',()=>document.querySelectorAll('details').forEach(d=>d.open=false));
document.querySelectorAll('.chip[data-filter]').forEach(c=>c.addEventListener('click',()=>{
  document.querySelectorAll('.chip[data-filter]').forEach(x=>x.classList.remove('active'));
  c.classList.add('active'); activeFilter=c.dataset.filter; applyFilters();
}));
q.addEventListener('input',applyFilters);

/* ---------- PRICE TABLE ---------- */
const priceTbody=document.querySelector('#priceTable tbody');
const pempty=document.getElementById('pempty');
const pq=document.getElementById('pq');

function parseAmt(s){const n=parseFloat(s);return isNaN(n)?0:n;}
const rows=PRICES.map(([name,strength,price,unit,stock])=>{
  const amount=parseAmt(strength);
  return {name,strength,amount,price,ppu: amount?price/amount:0,unit,stock:Number(stock)||0};
});

function renderPrices(list){
  priceTbody.innerHTML=list.map(r=>`
    <tr>
      <td>${esc(r.name)}</td>
      <td>${esc(r.strength)}</td>
      <td class="num">${r.amount?num(r.amount):'—'}</td>
      <td class="num">${money(r.price)}</td>
      <td class="num">${r.amount?money(r.ppu):'—'}</td>
      <td class="num">${r.stock}</td>
      <td><span class="unit-pill">${esc(r.unit)}</span></td>
    </tr>`).join('');
  pempty.style.display=list.length?'none':'block';
}
renderPrices(rows);

pq.addEventListener('input',()=>{
  const t=pq.value.toLowerCase();
  renderPrices(rows.filter(r=>(r.name+' '+r.strength).toLowerCase().includes(t)));
});

document.querySelectorAll('th.sort').forEach(th=>{
  let dir=1; th.addEventListener('click',()=>{
    const key=th.dataset.sort;
    const sorted=[...rows].sort((a,b)=> (typeof a[key]==='number' ? (a[key]-b[key]) : String(a[key]).localeCompare(String(b[key]))) * (dir));
    dir*=-1; renderPrices(sorted);
  });
});

/* ---------- Tabs ---------- */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    t.classList.add('active');
    document.getElementById(t.dataset.tab).classList.add('active');
  });
});
</script>
</body>
</html>
